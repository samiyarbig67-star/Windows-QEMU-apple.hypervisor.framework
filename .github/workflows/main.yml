name: macOS QEMU HVF + Windows 11 + NoMachine + Tailscale

on:
  workflow_dispatch:

jobs:
  vm:
    runs-on: macos-14

    timeout-minutes: 360

    steps:
    # ==============================
    - name: Checkout
      uses: actions/checkout@v4

    # ==============================
    - name: Setup Homebrew
      shell: bash
      run: |
        if ! command -v brew >/dev/null 2>&1; then
          /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
        fi
        echo "$(/opt/homebrew/bin/brew shellenv)" >> $GITHUB_ENV
        echo "$(/usr/local/bin/brew shellenv)" >> $GITHUB_ENV
        eval "$(/opt/homebrew/bin/brew shellenv)"

    # ==============================
    - name: Install QEMU
      shell: bash
      run: |
        brew update
        brew install qemu

    # ==============================
    - name: Install NoMachine
      shell: bash
      run: |
        brew install --cask nomachine --no-quarantine

    # ==============================
    - name: Setup Tailscale (Safe Mode)
      env:
        TS_KEY: ${{ secrets.TAILSCALE_AUTHKEY }}
      shell: bash
      run: |
        brew install --cask --no-quarantine tailscale

        # لینک مستقیم binary اگر brew link fail شد
        sudo ln -sf /Applications/Tailscale.app/Contents/MacOS/Tailscale /usr/local/bin/tailscale

        # صبر کوتاه برای daemon
        sleep 5

        # Tailscale up با authkey
        sudo tailscale up --authkey="$TS_KEY" --hostname="macos-win11-runner" --accept-routes || true

    # ==============================
    - name: Get Tailscale IP
      shell: bash
      run: |
        TS_IP=$(tailscale ip -4)
        echo "Tailscale IP: $TS_IP"

    # ==============================
    - name: Prepare VM
      shell: bash
      run: |
        mkdir -p $HOME/vm
        qemu-img create -f qcow2 $HOME/vm/win11.qcow2 80G
        curl -L -o $HOME/vm/Win11.iso https://archive.org/download/win-11-english-x-64_202111/Win11_English_x64.iso

    # ==============================
    - name: Run Windows 11 VM
      shell: bash
      run: |
        qemu-system-x86_64 \
          -machine q35,accel=hvf \
          -cpu host \
          -smp 4 \
          -m 6G \
          -drive file=$HOME/vm/win11.qcow2,format=qcow2 \
          -cdrom $HOME/vm/Win11.iso \
          -boot d \
          -netdev user,id=net0,hostfwd=tcp::3389-:3389 \
          -device virtio-net-pci,netdev=net0 \
          -display none \
          -daemonize

    # ==============================
    - name: Keep Runner Alive
      shell: bash
      run: |
        while true; do sleep 60; done
